<!doctype html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>每日推荐股票看板</title>

  <style>
    :root{
      --bg:#ffffff;
      --subtle:#f6f6f5;
      --text:#111;
      --muted:#6b7280;
      --border:#e6e6e3;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius:12px;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", "Noto Sans SC", sans-serif;
    }
    body{ margin:0; background:var(--subtle); color:var(--text); }
    .wrap{ max-width:1100px; margin:0 auto; padding:20px 14px 50px; }
    .card{
      background:var(--bg); border:1px solid var(--border);
      border-radius:var(--radius); box-shadow: var(--shadow);
    }
    header{ padding:18px 18px 10px; }
    h1{ margin:0 0 6px; font-size:22px; font-weight:750; letter-spacing:.2px;}
    .desc{ margin:0; color:var(--muted); font-size:14px; line-height:1.5; }

    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:14px 18px; border-top:1px solid var(--border);
      align-items:center; justify-content:space-between;
    }
    .left{ display:flex; gap:10px; flex:1 1 420px; align-items:center; }
    input[type="search"]{
      flex:1; padding:10px 12px; border:1px solid var(--border); border-radius:10px;
      font-size:14px; outline:none; background:#fff;
    }
    button{
      padding:10px 12px; border-radius:10px; border:1px solid var(--border);
      background:#fff; cursor:pointer; font-weight:650;
    }
    button.primary{ background:#111; color:#fff; border-color:#111; }
    .meta{ color:var(--muted); font-size:13px; }

    .table-wrap{ overflow:auto; border-top:1px solid var(--border); }
    table{ width:100%; min-width:940px; border-collapse:collapse; }
    th,td{ padding:12px 14px; border-bottom:1px solid var(--border); font-size:14px; vertical-align:top; }
    th{ text-align:left; color:#111; background:#fff; position:sticky; top:0; z-index:1; }
    tbody tr{ cursor:pointer; }
    tbody tr:hover{ background:#fafafa; }

    .ticker{ font-weight:750; letter-spacing:.2px; }
    .muted{ color:var(--muted); }
    .num{ font-variant-numeric: tabular-nums; white-space:nowrap; }

    .scoreBox{ display:flex; flex-direction:column; gap:6px; }
    .bar{ height:8px; background:#f1f1ef; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
    .bar span{ display:block; height:100%; width:0%; background:#111; }
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--border); background:#fff;
      border-radius:999px; padding:4px 10px; width:fit-content;
      font-size:12px; color:#111; font-weight:650;
    }

    footer{
      padding:12px 18px;
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
      color:var(--muted); font-size:13px;
    }

    /* Drawer */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.45); opacity:0; pointer-events:none; transition:200ms; }
    .overlay.open{ opacity:1; pointer-events:auto; }
    .drawer{
      position:fixed; top:0; right:0; height:100%;
      width:min(560px, 100%);
      background:#fff; border-left:1px solid var(--border);
      transform:translateX(105%); transition:220ms;
      display:flex; flex-direction:column;
      box-shadow: -10px 0 30px rgba(0,0,0,.12);
    }
    .drawer.open{ transform:translateX(0); }
    .dhead{ padding:14px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:10px; }
    .dtitle{ display:flex; flex-direction:column; gap:4px; }
    .dtitle strong{ font-size:16px; }
    .dtitle small{ color:var(--muted); }
    .dbody{ padding:14px 16px; overflow:auto; display:flex; flex-direction:column; gap:12px; }

    .seg{ display:flex; gap:8px; flex-wrap:wrap; }
    .seg button{ padding:8px 10px; border-radius:999px; }
    .seg button.active{ background:#111; color:#fff; border-color:#111; }

    .panel{ border:1px solid var(--border); border-radius:12px; padding:12px; }
    #chart{ width:100%; height:360px; }
    .hint{ font-size:13px; color:var(--muted); line-height:1.5; }

    @media (max-width:720px){
      table{ min-width:900px; }
      #chart{ height:320px; }
      .left{ flex-direction:column; align-items:stretch; }
      .left button{ width:100%; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <header>
        <h1>每日推荐股票看板</h1>
        <p class="desc">Notion 风格极简版：点任意一行可打开 K 线（日/周/年），并显示现价虚线 + 目标价虚线。</p>
      </header>

      <div class="toolbar">
        <div class="left">
          <input id="q" type="search" placeholder="筛选：股票 / 理由 / 推荐人 / 等级(A/B/C)" />
          <button class="primary" id="reload">刷新数据</button>
          <button id="clear">清空</button>
        </div>
        <div class="meta" id="meta">最后更新：--</div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">股票</th>
              <th style="width:210px;">推荐指数</th>
              <th style="width:110px;">现价</th>
              <th style="width:110px;">目标价</th>
              <th>推荐理由</th>
              <th style="width:160px;">推荐人</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <footer>
        <div>共 <span id="count">0</span> 条</div>
        <div>数据来源：GitHub Actions 生成 JSON（同域读取，无 CORS 问题）</div>
      </footer>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>
  <aside class="drawer" id="drawer" aria-hidden="true">
    <div class="dhead">
      <div class="dtitle">
        <strong id="dsym">--</strong>
        <small id="dsub">--</small>
      </div>
      <button id="dclose">关闭</button>
    </div>

    <div class="dbody">
      <div class="panel">
        <div class="seg">
          <button data-tf="D" class="active">日</button>
          <button data-tf="W">周</button>
          <button data-tf="Y">年</button>
        </div>
        <div class="hint" id="tfHint">日：最近 6 个月｜周：周K聚合｜年：最近 1 年</div>
      </div>

      <div class="panel">
        <div id="chart"></div>
        <div class="hint" id="chartHint">加载中…</div>
      </div>

      <div class="panel">
        <div class="hint" id="info">--</div>
      </div>
    </div>
  </aside>

  <script src="https://unpkg.com/lightweight-charts@5.1.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const tbody = document.getElementById("tbody");
    const q = document.getElementById("q");
    const count = document.getElementById("count");
    const meta = document.getElementById("meta");
    const reloadBtn = document.getElementById("reload");
    const clearBtn = document.getElementById("clear");

    const overlay = document.getElementById("overlay");
    const drawer = document.getElementById("drawer");
    const dclose = document.getElementById("dclose");
    const dsym = document.getElementById("dsym");
    const dsub = document.getElementById("dsub");
    const chartEl = document.getElementById("chart");
    const chartHint = document.getElementById("chartHint");
    const info = document.getElementById("info");
    const tfButtons = Array.from(document.querySelectorAll(".seg button[data-tf]"));

    let rows = [];
    let filtered = [];
    let current = null;
    let currentTf = "D";

    // chart
    let chart, series, lineNow, lineTarget;

    const usd = (n) => (Number.isFinite(n) ? `$${Number(n).toFixed(2)}` : "--");
    const grade = (s) => s >= 85 ? "A" : s >= 70 ? "B" : "C";

    const ensureChart = () => {
      if (chart) return;
      chartEl.innerHTML = "";
      chart = LightweightCharts.createChart(chartEl, {
        width: chartEl.clientWidth,
        height: chartEl.clientHeight,
        layout: { background: { type:"solid", color:"#fff" }, textColor:"#111" },
        grid: { vertLines: { color:"#eee" }, horzLines:{ color:"#eee" } },
        rightPriceScale: { borderColor:"#e6e6e3" },
        timeScale: { borderColor:"#e6e6e3" },
      });
      series = chart.addCandlestickSeries({
        upColor:"#111",
        downColor:"#999",
        borderUpColor:"#111",
        borderDownColor:"#999",
        wickUpColor:"#111",
        wickDownColor:"#999",
        priceLineVisible:false,
        lastValueVisible:false,
      });
      new ResizeObserver(() => {
        if (!chart) return;
        chart.applyOptions({ width: chartEl.clientWidth, height: chartEl.clientHeight });
      }).observe(chartEl);
    };

    const setLines = (nowPrice, targetPrice) => {
      if (lineNow) { series.removePriceLine(lineNow); lineNow = null; }
      if (lineTarget) { series.removePriceLine(lineTarget); lineTarget = null; }

      if (Number.isFinite(nowPrice)) {
        lineNow = series.createPriceLine({
          price: nowPrice,
          color: "rgba(17,17,17,0.9)",
          lineWidth: 2,
          lineStyle: 2, // dashed
          axisLabelVisible: true,
          title: `现价 ${usd(nowPrice)}`
        });
      }
      if (Number.isFinite(targetPrice)) {
        lineTarget = series.createPriceLine({
          price: targetPrice,
          color: "rgba(17,17,17,0.55)",
          lineWidth: 2,
          lineStyle: 2, // dashed
          axisLabelVisible: true,
          title: `目标价 ${usd(targetPrice)}`
        });
      }
    };

    const lastN = (arr, n) => arr.length > n ? arr.slice(arr.length - n) : arr;

    const toWeekly = (daily) => {
      const getWeekKey = (dateStr) => {
        const d = new Date(dateStr + "T00:00:00");
        const day = (d.getDay() + 6) % 7; // Mon=0
        d.setDate(d.getDate() - day);
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${dd}`;
      };
      const map = new Map();
      for (const c of daily) {
        const key = getWeekKey(c.time);
        if (!map.has(key)) map.set(key, { time:key, open:c.open, high:c.high, low:c.low, close:c.close });
        else {
          const w = map.get(key);
          w.high = Math.max(w.high, c.high);
          w.low = Math.min(w.low, c.low);
          w.close = c.close;
        }
      }
      return Array.from(map.values()).sort((a,b)=>a.time<b.time?-1:1);
    };

    async function loadQuotes() {
      // cache bust
      const res = await fetch(`data/quotes.json?t=${Date.now()}`, { cache:"no-store" });
      if (!res.ok) throw new Error("quotes.json 加载失败");
      return res.json();
    }

    async function loadCandles(symbol) {
      const res = await fetch(`data/candles/${symbol}.json?t=${Date.now()}`, { cache:"no-store" });
      if (!res.ok) throw new Error(`candles/${symbol}.json 加载失败`);
      return res.json();
    }

    function renderTable(list) {
      tbody.innerHTML = list.map((r, idx) => {
        const g = grade(r.score);
        return `
          <tr data-idx="${idx}">
            <td class="ticker">${r.symbol}</td>
            <td>
              <div class="scoreBox">
                <div class="bar"><span style="width:${r.score}%"></span></div>
                <span class="pill">指数 ${r.score} · ${g}</span>
              </div>
            </td>
            <td class="num">${usd(r.currentPrice)}</td>
            <td class="num"><b>${usd(r.targetPrice)}</b></td>
            <td>${r.reason}</td>
            <td class="muted">${r.recommender}</td>
          </tr>
        `;
      }).join("");
      count.textContent = list.length;

      Array.from(tbody.querySelectorAll("tr[data-idx]")).forEach(tr=>{
        tr.addEventListener("click", () => {
          const i = Number(tr.dataset.idx);
          openDrawer(list[i]);
        });
      });
    }

    function applyFilter() {
      const keyword = q.value.trim().toLowerCase();
      if (!keyword) {
        filtered = rows;
      } else {
        filtered = rows.filter(r => {
          const g = grade(r.score).toLowerCase();
          return [r.symbol, r.reason, r.recommender, g].some(x => String(x).toLowerCase().includes(keyword));
        });
      }
      renderTable(filtered);
    }

    async function refresh() {
      try {
        const payload = await loadQuotes();
        rows = payload.rows || [];
        meta.textContent = `最后更新：${payload.lastUpdated || "--"}`;
        applyFilter();
      } catch (e) {
        meta.textContent = "最后更新：加载失败（请确认 data/quotes.json 是否存在）";
        console.error(e);
      }
    }

    function openUI() {
      overlay.classList.add("open");
      drawer.classList.add("open");
      drawer.setAttribute("aria-hidden", "false");
    }
    function closeUI() {
      overlay.classList.remove("open");
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden", "true");
    }

    async function openDrawer(row) {
      current = row;
      currentTf = "D";
      tfButtons.forEach(b => b.classList.toggle("active", b.dataset.tf==="D"));

      dsym.textContent = row.symbol;
      dsub.textContent = `${row.recommender} · 指数 ${row.score}（${grade(row.score)}）`;
      info.textContent = `现价：${usd(row.currentPrice)} ｜ 目标价：${usd(row.targetPrice)} ｜ 理由：${row.reason}`;

      openUI();
      await renderChart();
    }

    async function renderChart() {
      if (!current) return;
      ensureChart();
      chartHint.textContent = "加载中…";

      try {
        const payload = await loadCandles(current.symbol);
        const daily = payload.candles || [];
        if (!daily.length) throw new Error("candles 为空");

        let show = daily;
        if (currentTf === "D") show = lastN(daily, 126);
        if (currentTf === "Y") show = lastN(daily, 252);
        if (currentTf === "W") show = lastN(toWeekly(daily), 156);

        series.setData(show);
        chart.timeScale().fitContent();

        const nowPrice = payload.currentPrice;
        const targetPrice = current.targetPrice;

        setLines(nowPrice, targetPrice);
        chartHint.textContent = `${current.symbol} · ${currentTf==="D"?"日K":"周K/年K"}`;
        info.textContent = `现价：${usd(nowPrice)} ｜ 目标价：${usd(targetPrice)} ｜ 理由：${current.reason}`;
      } catch (e) {
        chartHint.textContent = "K 线加载失败：请确认 data/candles/*.json 已由 Action 生成。";
        console.error(e);
      }
    }

    q.addEventListener("input", applyFilter);
    reloadBtn.addEventListener("click", refresh);
    clearBtn.addEventListener("click", () => { q.value=""; applyFilter(); });

    overlay.addEventListener("click", closeUI);
    dclose.addEventListener("click", closeUI);
    window.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeUI(); });

    tfButtons.forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        if (!current) return;
        currentTf = btn.dataset.tf;
        tfButtons.forEach(b=>b.classList.toggle("active", b===btn));
        await renderChart();
      });
    });

    refresh();
  </script>
</body>
</html>